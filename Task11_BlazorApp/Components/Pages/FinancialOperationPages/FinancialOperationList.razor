@using Microsoft.AspNetCore.WebUtilities
@using Services
@using Task11_Common.ViewModels

@page "/financialoperations"
@inject IFinancialOperationService FinancialOperationService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudText Typo="Typo.h4" Style="margin-bottom: 10px; margin-top: 20px;">Financial Operations</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" Style="margin-bottom: 20px" OnClick="NavigateToCreate">Create</MudButton>

@if (string.IsNullOrEmpty(_errorMessage))
{
    if (_financialOperations == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable Items="_financialOperations" Hover="true" FixedHeader="true">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Amount</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Operation Type</MudTh>
                <MudTh>Action</MudTh>
            </HeaderContent>
            
            <RowTemplate>
                <MudTd DataLabel="Date">@context.Date?.ToString("dd.MM.yyyy")</MudTd>
                <MudTd DataLabel="Amount">@context.Amount</MudTd>
                <MudTd DataLabel="Description">@context.Description</MudTd>
                <MudTd DataLabel="Operation Type">@context.OperationTypeName</MudTd>
                <MudTd DataLabel="Action">
                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit" Color="Color.Default" OnClick="@(() => NavigateToEdit(@context.Id))">Edit</MudButton>
                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => ConfirmDelete(@context.Id))">Delete</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>

        @if (!string.IsNullOrEmpty(_resultMessage))
        {
            Snackbar.Add(_resultMessage, Severity.Success);
            _resultMessage = "";
        }
    }
}

@code {
    private IEnumerable<FinancialOperationViewModelCommon> _financialOperations;

    private string _errorMessage;
    private string _resultMessage;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("message", out var message))
        {
            _resultMessage = message;
        }

        try
        {
            _financialOperations = await FinancialOperationService.GetFinancialOperations();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo($"/financialoperations/create?message={_resultMessage}");    
    }

    private void NavigateToEdit(int id)
    {
        NavigationManager.NavigateTo($"/financialoperations/edit/{id}?message={_resultMessage}");
    }

    private async Task DeleteFinancialOperation(int id)
    {
        try
        {
            _resultMessage = await FinancialOperationService.DeleteFinancialOperation(id);
            _financialOperations = await FinancialOperationService.GetFinancialOperations();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }    
    }

    private async Task ConfirmDelete (int id)
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            BackdropClick = false,
        };

        var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>("Confirm Delete", options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await DeleteFinancialOperation(id);
        }
    }
}
